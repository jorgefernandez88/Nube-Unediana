<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Aranceles UNED</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <!-- Fuente Orbitron para timer digital -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <header>
        <h1><i class="fas fa-calculator"></i> Calculadora de Aranceles UNED</h1>
        <nav>
            <ul class="menu">
                <li><a href="index.html"><i class="fas fa-arrow-left"></i> Volver al inicio <i class="fas fa-home"></i></a></li>
            </ul>
            <div class="theme-switch-wrapper">
                <label class="theme-switch" for="checkbox">
                    <input type="checkbox" id="checkbox" onchange="toggleTheme()" />
                    <div class="slider">
                        <span class="theme-icon sun">‚òÄÔ∏è</span>
                        <span class="theme-icon moon">üåô</span>
                    </div>
                </label>
            </div>
        </nav>
    </header>
    <main>
        <div class="container-aranceles">
            <h2>Seleccione su tipo de beca</h2>
            <div class="beca-selector">
                <div class="beca-option">
                    <input type="radio" id="sin-beca" name="tipo-beca" value="sin-beca" checked>
                    <label for="sin-beca">Sin beca</label>
                </div>
                <div class="beca-option">
                    <input type="radio" id="beca-A" name="tipo-beca" value="beca-a">
                    <label for="beca-A">Beca A</label>
                </div>
                <div class="beca-option">
                    <input type="radio" id="beca-B" name="tipo-beca" value="beca-b">
                    <label for="beca-B">Beca B</label>
                </div>
                <div class="beca-option">
                    <input type="radio" id="beca-C" name="tipo-beca" value="beca-c">
                    <label for="beca-C">Beca C</label>
                </div>
                <div class="beca-option">
                    <input type="radio" id="beca-D" name="tipo-beca" value="beca-d">
                    <label for="beca-D">Beca D</label>
                </div>
                <div class="beca-option">
                    <input type="radio" id="beca-E" name="tipo-beca" value="beca-e">
                    <label for="beca-E">Beca E</label>
                </div>
            </div>

            <div class="programa-selector">
                <h3>Seleccione su nivel acad√©mico</h3>
                <div class="custom-select-wrapper">
                    <select id="programa-academico">
                        <option value="tecnico">T√©cnico/Diplomado</option>
                        <option value="profesorado">Profesorado/Bachillerato</option>
                        <option value="licenciatura">Licenciatura</option>
                    </select>
                    <div class="custom-select-trigger">
                        <span class="custom-select-value">T√©cnico/Diplomado</span>
                        <span class="custom-select-arrow">‚ñº</span>
                    </div>
                    <div class="custom-select-options">
                        <div class="custom-select-option selected" data-value="tecnico">T√©cnico/Diplomado</div>
                        <div class="custom-select-option" data-value="profesorado">Profesorado/Bachillerato</div>
                        <div class="custom-select-option" data-value="licenciatura">Licenciatura</div>
                    </div>
                </div>
            </div>
            
            <div id="beca-mensaje" class="beca-mensaje"></div>
            <div class="aranceles-tabla-container">
                <h3>Aranceles por materias (en colones)</h3>
                <table class="aranceles-tabla">
                    <thead>
                        <tr>
                            <th></th>
                            <th>Tipo de Materia</th>
                            <th>Precio</th>
                            <th>Cantidad</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-aranceles-body"></tbody>
                </table>
            </div>
            <div class="resumen-aranceles">
                <h3>Resumen de tu selecci√≥n</h3>
                <div id="lista-seleccion" class="lista-seleccion"></div>
                <div class="total-container">
                    <strong>Total a pagar:</strong>
                    <span id="total-pagar">‚Ç°0</span>
                </div>
            </div>
        </div>
    </main>
    <footer>
        <nav>
            <a href="https://www.facebook.com/educadcr"><i class="fab fa-facebook"></i></a>
        </nav>
        <h5>&copy; 2025 Proyecto de Educaci√≥n a Distancia CR <br> Elaborado por Jorge Fern√°ndez</h5>
        <h5><a href="avisolegal.html" class="legal-link">Aviso Legal</a></h5>
    </footer>

    <!-- Audios -->
    <audio id="themeSwitchSound" preload="auto">
        <source src="sounds/prendido.mp3" type="audio/mpeg">
    </audio>
    <audio id="becaSelectSound" preload="auto">
        <source src="sounds/modpomodoro.mp3" type="audio/mpeg">
    </audio>

    <script>
        // ===== VARIABLES GLOBALES =====
        let arancelesData = null;
        let itemsSeleccionados = [];
        let audioDesbloqueado = false;
        
        const arancelesMatricula = {
            "sin-beca": 17293, "beca-a": 0, "beca-b": 2700,
            "beca-c": 6348.25, "beca-d": 9996.50, "beca-e": 13644.75
        };

        // ===== FUNCIONES DE AUDIO =====
        function desbloquearAudio() {
            if (audioDesbloqueado) return;
            const audios = [
                document.getElementById('themeSwitchSound'),
                document.getElementById('becaSelectSound')
            ];
            audios.forEach(audio => {
                if (audio) {
                    audio.volume = 0;
                    audio.play().then(() => {
                        audio.pause();
                        audio.currentTime = 0;
                        audio.volume = 1;
                    }).catch(e => {});
                }
            });
            audioDesbloqueado = true;
        }

        function reproducirSonidoSeguro(audioId, volumen = 1) {
            const audio = document.getElementById(audioId);
            if (!audio) return;
            audio.currentTime = 0;
            audio.volume = volumen;
            audio.play().catch(e => console.log('Error audio:', e.message));
        }

        // ===== SELECT PERSONALIZADO =====
        document.addEventListener('DOMContentLoaded', function() {
            const wrapper = document.querySelector('.custom-select-wrapper');
            if (wrapper) {
                const trigger = wrapper.querySelector('.custom-select-trigger');
                const options = wrapper.querySelector('.custom-select-options');
                const optionElements = wrapper.querySelectorAll('.custom-select-option');
                const valueDisplay = wrapper.querySelector('.custom-select-value');
                const hiddenSelect = wrapper.querySelector('select');

                trigger.addEventListener('click', function(e) {
                    e.stopPropagation();
                    trigger.classList.toggle('active');
                    options.classList.toggle('active');
                });

                optionElements.forEach(option => {
                    option.addEventListener('click', function() {
                        const value = this.getAttribute('data-value');
                        const text = this.textContent.trim();
                        valueDisplay.textContent = text;
                        optionElements.forEach(opt => opt.classList.remove('selected'));
                        this.classList.add('selected');
                        hiddenSelect.value = value;
                        hiddenSelect.dispatchEvent(new Event('change', { bubbles: true }));
                        trigger.classList.remove('active');
                        options.classList.remove('active');
                    });
                });

                document.addEventListener('click', function(e) {
                    if (!wrapper.contains(e.target)) {
                        trigger.classList.remove('active');
                        options.classList.remove('active');
                    }
                });

                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape') {
                        trigger.classList.remove('active');
                        options.classList.remove('active');
                    }
                });
            }

            document.body.addEventListener('click', desbloquearAudio, { once: true });
            document.body.addEventListener('touchstart', desbloquearAudio, { once: true });
            inicializarCalculadoraAranceles();
            loadTheme();
        });

        // ===== CARGAR ARANCELES =====
        async function cargarAranceles() {
            try {
                const response = await fetch('aranceles.json');
                if (!response.ok) throw new Error(`Error: ${response.status}`);
                arancelesData = await response.json();
            } catch (error) {
                console.error('Error cargando aranceles:', error);
                alert(`Error al cargar aranceles: ${error.message}`);
            }
        }

        // ===== INICIALIZAR CALCULADORA =====
        async function inicializarCalculadoraAranceles() {
            await cargarAranceles();
            if (!arancelesData) return;

            const tablaBody = document.getElementById('tabla-aranceles-body');
            if (!tablaBody) return;

            const categorias = {
                "Asignaturas nuevas": ["asignatura_regular", "asignatura_laboratorio", "asignatura_gira", "asignatura_laboratorio_gira", "laboratorio_independiente"],
                "Asignaturas repetidas": ["asignatura_repetida", "repetida_laboratorio", "repetida_gira", "repetida_laboratorio_gira"],
                "TFG/Pr√°cticas": ["practica_tesis"]
            };

            for (const [categoriaNombre, ids] of Object.entries(categorias)) {
                const categoriaRow = document.createElement('tr');
                categoriaRow.className = 'categoria';
                categoriaRow.innerHTML = `<td colspan="4">${categoriaNombre}</td>`;
                tablaBody.appendChild(categoriaRow);

                ids.forEach(id => {
                    const item = arancelesData.aranceles.find(a => a.id === id);
                    if (item) {
                        const row = document.createElement('tr');
                        row.id = `fila-${id}`;
                        row.innerHTML = `
                            <td><input type="checkbox" class="seleccionar-item" data-id="${id}"></td>
                            <td>${item.nombre}</td>
                            <td class="precio" data-id="${id}">‚Ç°0</td>
                            <td><input type="number" class="cantidad" data-id="${id}" min="1" value="0" placeholder="0"></td>
                        `;
                        tablaBody.appendChild(row);
                    }
                });
            }

            inicializarEventosAranceles();
            actualizarPrecios();
            mostrarMensajeBeca();
            recalcularTotal();
        }

        // ===== EVENTOS DE ARANCELES =====
        function inicializarEventosAranceles() {
            const becaOptions = document.querySelectorAll('input[name="tipo-beca"]');
            const programaSelect = document.getElementById('programa-academico');
            const checkboxes = document.querySelectorAll('.seleccionar-item');
            const cantidades = document.querySelectorAll('.cantidad');

            // ‚≠ê EVENTO CON SONIDO PARA BECAS
            becaOptions.forEach(option => {
                option.addEventListener('change', function() {
                    desbloquearAudio();
                    reproducirSonidoSeguro('becaSelectSound');
                    actualizarPrecios();
                    mostrarMensajeBeca();
                    recalcularTotal();
                });
            });

            programaSelect.addEventListener('change', function() {
                actualizarPrecios();
                recalcularTotal();
            });

            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const id = this.getAttribute('data-id');
                    const cantidadInput = document.querySelector(`.cantidad[data-id="${id}"]`);
                    
                    if (this.checked) {
                        cantidadInput.value = 1;
                        const precioUnitario = getPrecioActual(id);
                        const itemIndex = itemsSeleccionados.findIndex(item => item.id === id);
                        const nuevoItem = {
                            id, nombre: this.closest('tr').querySelector('td:nth-child(2)').textContent,
                            precioUnitario, cantidad: 1, total: precioUnitario
                        };
                        if (itemIndex !== -1) itemsSeleccionados[itemIndex] = nuevoItem;
                        else itemsSeleccionados.push(nuevoItem);
                    } else {
                        cantidadInput.value = 0;
                        itemsSeleccionados = itemsSeleccionados.filter(item => item.id !== id);
                    }
                    actualizarResumen();
                    recalcularTotal();
                });
            });

            cantidades.forEach(cantidad => {
                cantidad.addEventListener('change', function() {
                    const id = this.getAttribute('data-id');
                    const checkbox = document.querySelector(`.seleccionar-item[data-id="${id}"]`);
                    const nuevaCantidad = parseInt(this.value) || 0;

                    if (nuevaCantidad > 0) {
                        const precioUnitario = getPrecioActual(id);
                        const itemIndex = itemsSeleccionados.findIndex(item => item.id === id);
                        const nuevoItem = {
                            id, nombre: checkbox.closest('tr').querySelector('td:nth-child(2)').textContent,
                            precioUnitario, cantidad: nuevaCantidad, total: precioUnitario * nuevaCantidad
                        };
                        if (itemIndex !== -1) itemsSeleccionados[itemIndex] = nuevoItem;
                        else { itemsSeleccionados.push(nuevoItem); checkbox.checked = true; }
                    } else {
                        checkbox.checked = false;
                        itemsSeleccionados = itemsSeleccionados.filter(item => item.id !== id);
                    }
                    actualizarResumen();
                    recalcularTotal();
                });

                cantidad.addEventListener('input', function() {
                    const id = this.getAttribute('data-id');
                    const checkbox = document.querySelector(`.seleccionar-item[data-id="${id}"]`);
                    const nuevaCantidad = parseInt(this.value) || 0;

                    if (nuevaCantidad > 0 && !checkbox.checked) {
                        checkbox.checked = true;
                        const precioUnitario = getPrecioActual(id);
                        itemsSeleccionados.push({
                            id, nombre: checkbox.closest('tr').querySelector('td:nth-child(2)').textContent,
                            precioUnitario, cantidad: nuevaCantidad, total: precioUnitario * nuevaCantidad
                        });
                        actualizarResumen();
                        recalcularTotal();
                    }
                });
            });
        }

        function getPrecioActual(id) {
            if (!arancelesData) return 0;
            const tipoBeca = document.querySelector('input[name="tipo-beca"]:checked').value;
            const programaAcademico = document.getElementById('programa-academico').value;
            const item = arancelesData.aranceles.find(a => a.id === id);
            if (!item) return 0;
            if (arancelesData.becas_exentas.includes(tipoBeca)) return 0;
            const categoriaPrograma = item.categorias[programaAcademico];
            if (categoriaPrograma) {
                const precio = categoriaPrograma[tipoBeca];
                return precio !== undefined ? precio : (categoriaPrograma["sin-beca"] || 0);
            }
            return 0;
        }

        function actualizarPrecios() {
            if (!arancelesData) return;
            document.querySelectorAll('.precio').forEach(el => {
                const id = el.getAttribute('data-id');
                el.textContent = `‚Ç°${getPrecioActual(id).toLocaleString('es-CR')}`;
            });
            itemsSeleccionados.forEach(item => {
                item.precioUnitario = getPrecioActual(item.id);
                item.total = item.precioUnitario * item.cantidad;
            });
            actualizarResumen();
            recalcularTotal();
        }

        function mostrarMensajeBeca() {
            const tipoBeca = document.querySelector('input[name="tipo-beca"]:checked').value;
            const becaMensaje = document.getElementById('beca-mensaje');
            if (arancelesData && arancelesData.becas_exentas.includes(tipoBeca)) {
                becaMensaje.innerHTML = `<div class="beca-mensaje-especial">Los estudiantes con beca ${tipoBeca.toUpperCase()} tienen exenci√≥n del 100% en todos los aranceles de materias</div>`;
            } else {
                becaMensaje.innerHTML = '';
            }
        }

        function getNombreBeca(tipoBeca) {
            const nombres = { "sin-beca": "Sin beca", "beca-a": "Beca A", "beca-b": "Beca B", "beca-c": "Beca C", "beca-d": "Beca D", "beca-e": "Beca E" };
            return nombres[tipoBeca] || tipoBeca;
        }

        function pluralizarConcepto(concepto, cantidad) {
            if (cantidad === 1) return concepto;
            const plurales = {
                'Asignatura regular': 'Asignaturas regulares',
                'Asignatura con laboratorio': 'Asignaturas con laboratorio',
                'Asignatura con gira de campo': 'Asignaturas con gira de campo',
                'Asignatura con lab. y gira': 'Asignaturas con lab. y gira',
                'Asignatura repetida': 'Asignaturas repetidas',
                'Repetida con laboratorio': 'Repetidas con laboratorio',
                'Repetida con gira de campo': 'Repetidas con gira de campo',
                'Repetida con laboratorio y gira': 'Repetidas con laboratorio y gira'
            };
            return plurales[concepto] || concepto;
        }

        function actualizarResumen() {
            const listaSeleccion = document.getElementById('lista-seleccion');
            if (!listaSeleccion) return;
            listaSeleccion.innerHTML = '';
            const ul = document.createElement('ul');
            const tipoBeca = document.querySelector('input[name="tipo-beca"]:checked').value;
            const matricula = arancelesMatricula[tipoBeca];
            
            const liMatricula = document.createElement('li');
            liMatricula.textContent = matricula > 0 
                ? `Arancel matr√≠cula cuatrimestral (${getNombreBeca(tipoBeca)}): ‚Ç°${matricula.toLocaleString('es-CR')}`
                : `Arancel matr√≠cula cuatrimestral (${getNombreBeca(tipoBeca)}): ‚Ç°0 (exento)`;
            ul.appendChild(liMatricula);
            
            if (itemsSeleccionados.length === 0) {
                const liVacio = document.createElement('li');
                liVacio.textContent = 'No hay materias seleccionadas';
                ul.appendChild(liVacio);
            } else {
                itemsSeleccionados.forEach(item => {
                    const li = document.createElement('li');
                    const concepto = pluralizarConcepto(item.nombre, item.cantidad);
                    li.textContent = item.cantidad > 1
                        ? `${item.cantidad} ${concepto}: ‚Ç°${item.precioUnitario.toLocaleString('es-CR')} √ó ${item.cantidad} = ‚Ç°${item.total.toLocaleString('es-CR')}`
                        : `${item.cantidad} ${concepto}: ‚Ç°${item.total.toLocaleString('es-CR')}`;
                    ul.appendChild(li);
                });
            }
            listaSeleccion.appendChild(ul);
        }

        function recalcularTotal() {
            const tipoBeca = document.querySelector('input[name="tipo-beca"]:checked').value;
            const totalPagar = document.getElementById('total-pagar');
            if (!totalPagar) return;
            let total = arancelesMatricula[tipoBeca];
            if (!arancelesData || !arancelesData.becas_exentas.includes(tipoBeca)) {
                itemsSeleccionados.forEach(item => total += item.total);
            }
            totalPagar.textContent = `‚Ç°${total.toLocaleString('es-CR')}`;
        }

        // ===== MODO OSCURO =====
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            desbloquearAudio();
            reproducirSonidoSeguro('themeSwitchSound');
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            const checkbox = document.getElementById('checkbox');
            if (checkbox) checkbox.checked = newTheme === 'dark';
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            const checkbox = document.getElementById('checkbox');
            if (checkbox) checkbox.checked = savedTheme === 'dark';
        }
    </script>
</body>
</html>